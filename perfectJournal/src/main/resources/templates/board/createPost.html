<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>감사일기 - 게시글 작성</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/common.css}"
      href="../static/css/common.css"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/createPost.css}"
      href="../static/css/createPost.css"
    />
  </head>

  <body>
    <nav th:replace="~{layout/header :: headerFrag}">네비게이션</nav>

    <div class="container">
      <a th:href="@{/posts}" class="back-button" id="backToList">
        <i class="bi bi-arrow-left"></i> 목록으로 돌아가기
      </a>

      <form
        id="postForm"
        method="post"
        th:action="@{/posts/create}"
        enctype="multipart/form-data"
      >
        <div
          class="d-flex justify-content-between align-items-center mb-4"
          style="border-bottom: 1px solid #eee; padding-bottom: 0.7rem"
        >
          <div>
            <label for="duration" class="form-label">타임캡슐</label>
            <select name="duration">
              <option value="">선택 안 함</option>
              <option value="7">7일</option>
              <option value="30">30일</option>
              <option value="365">365일</option>
            </select>
          </div>
          <div class="form-check" style="margin-left: auto">
            <input type="hidden" name="isLocked" value="0" />
            <input
              class="form-check-input"
              type="checkbox"
              value="1"
              id="isLocked"
              name="isLocked"
            />
            <label class="form-check-label" for="isLocked">비밀글 설정</label>
          </div>
        </div>
        <div class="mb-4">
          <label for="postTitle" class="form-label">제목</label>
          <input
            name="title"
            type="text"
            class="form-control"
            id="postTitle"
            placeholder="제목을 입력해주세요"
            maxlength="30"
            required
          />
          <div id="titleCountDiv" class="d-flex justify-content-end form-text">
            <span id="titleCount">0</span> / 30자
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label">썸네일 이미지</label>
          <div class="thumbnail-container" id="thumbnailContainer">
            <div class="thumbnail-placeholder" id="thumbnailPlaceholder">
              <i class="bi bi-image"></i>
              <span>이미지를 업로드해주세요</span>
            </div>
            <img
              src=""
              alt="썸네일 미리보기"
              class="thumbnail-preview"
              id="thumbnailPreview"
            />
            <input
              name="file"
              type="file"
              accept="image/*"
              class="thumbnail-input"
              id="thumbnailInput"
            />
          </div>
          <div class="form-text">권장 크기: 1200 x 800px, 최대 5MB</div>
        </div>
        <div class="mb-4">
          <label for="postContent" class="form-label">내용</label>
          <textarea
            name="content"
            class="form-control content-editor"
            id="editor"
            rows="10"
            placeholder="오늘 감사했던 일을 작성해주세요..."
          ></textarea>
        </div>
        <div class="form-buttons">
          <button type="button" class="btn btn-cancel" id="cancelButton">
            취소하기
          </button>
          <button type="submit" class="btn btn-submit">등록하기</button>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/ckeditor.js}"></script>
    <script>
      // 썸네일 이미지 미리보기
      document
        .getElementById("thumbnailInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];

          const isBigFile = checkFileSize(file);

          if (file && !isBigFile) {
            const reader = new FileReader();

            reader.onload = function (e) {
              const preview = document.getElementById("thumbnailPreview");
              const placeholder = document.getElementById(
                "thumbnailPlaceholder"
              );

              preview.src = e.target.result;
              preview.style.display = "block";
              placeholder.style.display = "none";
            };

            reader.readAsDataURL(file);
          } else {
            alert("이미지가 너무 큽니다.");
          }
        });

      // 취소 버튼 이벤트
      document
        .getElementById("cancelButton")
        .addEventListener("click", function () {
          if (
            confirm(
              "작성 중인 내용이 저장되지 않습니다. 정말 취소하시겠습니까?"
            )
          ) {
            window.location.href = "/posts";
          }
        });

      // 제목 글자 수 확인
      const titleCountEl = document.getElementById("titleCount");
      document
        .getElementById("postTitle")
        .addEventListener("keyup", function (e) {
          if (e.target.value.length > 30) {
            e.target.value = event.target.value.slice(0, 30);
          }

          if (e.target.value.length == 30) {
            document
              .getElementById("titleCountDiv")
              .setAttribute("style", "color: red;");
          } else {
            document
              .getElementById("titleCountDiv")
              .removeAttribute("color: red;");
          }
          return false;
        });

      function checkFileSize(file) {
        if (file.size > 5242880) {
          return true;
        }

        return false;
      }

      let editorInstance;

      async function insertStyledQuestion(editor) {
        const response = await fetch("/questions.json");
        const questions = await response.json();
        const random = questions[Math.floor(Math.random() * questions.length)];
        const rawQuestion = `#${random}`;
        const styledHTML = `<p><span style="color:gray; font-style:italic;">${rawQuestion}</span></p><p><br></p>`;
        editor.setData(styledHTML);
      }

      ClassicEditor.create(document.querySelector("#editor"), {
        simpleUpload: {
          uploadUrl: "/uploads",
        },
      })
        .then((editor) => {
          editorInstance = editor;
          insertStyledQuestion(editor);

          const form = document.getElementById("postForm");
          form.addEventListener("submit", function () {
            const editorData = editor.getData();
          });
        })
        .catch((error) => {
          console.error(error);
        });
    </script>
  </body>
</html>
