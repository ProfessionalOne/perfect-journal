<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>감사일기 - 상세 페이지</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/common.css}"
      href="../static/css/common.css"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/detail.css}"
      href="../static/css/detail.css"
    />
  <body>
    <nav th:replace="~{layout/header :: headerFrag}">네비게이션</nav>
    
    <div class="container">
      <a th:href="@{/posts}" class="back-button" id="backToList">
        <i class="bi bi-arrow-left"></i> 목록으로 돌아가기
      </a>

      <div class="post-container">
        <div class="post-header">
          <h1 class="post-title" id="postTitle" th:text="${bean.title}">
            오늘의 감사한 순간
          </h1>
          <div class="post-meta">
            <span class="post-author" id="postAuthor" th:text="${bean.nickname}"
              >김감사</span
            >
            <span
              class="post-date"
              id="postDate"
              th:text="${#dates.format(bean.createdAt, 'yyyy/MM/dd HH:mm')}"
              >2023-11-01 11:11</span
            >
          </div>
        </div>
        <div th:hidden="${bean.image}" class="d-flex justify-content-center">
          <img th:src="${bean.image}" alt="${bean.title}" />
        </div>
        <div class="post-content mt-4" id="postContent">
          <pre
            th:text="${bean.content}"
            style="white-space: pre-wrap; word-break: break-word"
          >
감사데스\n오늘도감사감사링</pre
          >
        </div>
      </div>

      <div class="comments-section">
        <h2 class="comments-title">
          댓글 <span class="comments-count" id="commentsCount">3</span>
        </h2>

        <div class="comment-form">
          <textarea
            class="form-control comment-input"
            rows="3"
            placeholder="댓글을 작성해주세요..."
          ></textarea>
          <button class="btn btn-comment">댓글 작성</button>
          <div class="clearfix"></div>
        </div>

        <div class="comments-list" id="commentsList">
          <!-- 댓글 1 -->
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author">이행복</span>
              <span class="comment-date">2023-11-01 14:23</span>
            </div>
            <div class="comment-text">
              저도 오늘 아침 맑은 하늘을 보고 기분이 좋아졌어요. 작은 것에
              감사하는 마음이 중요한 것 같아요.
            </div>
            <div class="comment-actions">
              <button class="btn-reply" data-comment-id="1">
                <i class="bi bi-reply"></i> 답글 달기
              </button>
            </div>

            <!-- 답글 작성 폼 -->
            <div class="reply-form" id="replyForm-1">
              <textarea
                class="form-control comment-input"
                rows="2"
                placeholder="답글을 작성해주세요..."
              ></textarea>
              <button class="btn btn-comment btn-sm">답글 작성</button>
              <div class="clearfix"></div>
            </div>

            <!-- 답글 목록 -->
            <div class="reply-item">
              <div class="comment-header">
                <span class="comment-author">김감사</span>
                <span class="comment-date">2023-11-01 15:10</span>
              </div>
              <div class="comment-text">
                맞아요! 감사한 마음으로 하루를 시작하면 정말 달라지는 것 같아요.
                댓글 감사합니다. :)
              </div>
            </div>
          </div>

          <!-- 댓글 2 -->
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author">박희망</span>
              <span class="comment-date">2023-11-01 16:45</span>
            </div>
            <div class="comment-text">
              감사일기 쓰기 시작한 지 한 달 정도 되었는데, 저도 비슷한 경험을
              했어요. 일상의 작은 행복들이 더 많이 보이더라고요. 좋은 글
              감사합니다!
            </div>
            <div class="comment-actions">
              <button class="btn-reply" data-comment-id="2">
                <i class="bi bi-reply"></i> 답글 달기
              </button>
            </div>

            <!-- 답글 작성 폼 -->
            <div class="reply-form" id="replyForm-2">
              <textarea
                class="form-control comment-input"
                rows="2"
                placeholder="답글을 작성해주세요..."
              ></textarea>
              <button class="btn btn-comment btn-sm">답글 작성</button>
              <div class="clearfix"></div>
            </div>
          </div>

          <!-- 댓글 3 -->
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author">최건강</span>
              <span class="comment-date">2023-11-02 09:12</span>
            </div>
            <div class="comment-text">
              감사일기 어떻게 시작하셨나요? 저도 시작해보고 싶은데 어떻게
              시작해야 할지 모르겠어요.
            </div>
            <div class="comment-actions">
              <button class="btn-reply" data-comment-id="3">
                <i class="bi bi-reply"></i> 답글 달기
              </button>
            </div>

            <!-- 답글 작성 폼 -->
            <div class="reply-form" id="replyForm-3">
              <textarea
                class="form-control comment-input"
                rows="2"
                placeholder="답글을 작성해주세요..."
              ></textarea>
              <button class="btn btn-comment btn-sm">답글 작성</button>
              <div class="clearfix"></div>
            </div>

            <!-- 답글 목록 -->
            <div class="reply-item">
              <div class="comment-header">
                <span class="comment-author">김감사</span>
                <span class="comment-date">2023-11-02 10:30</span>
              </div>
              <div class="comment-text">
                저는 매일 저녁 자기 전에 그날 있었던 감사한 일 3가지를 적는
                것부터 시작했어요. 작은 것부터 시작해보세요!
              </div>
            </div>

            <div class="reply-item">
              <div class="comment-header">
                <span class="comment-author">박희망</span>
                <span class="comment-date">2023-11-02 11:15</span>
              </div>
              <div class="comment-text">
                저도 김감사님처럼 시작했어요. 처음엔 어색했지만 곧 습관이
                되더라고요. 화이팅하세요!
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 답글 달기 버튼 이벤트
      document.querySelectorAll(".btn-reply").forEach((button) => {
        button.addEventListener("click", function () {
          const commentId = this.dataset.commentId;
          const replyForm = document.getElementById(`replyForm-${commentId}`);

          // 다른 모든 답글 폼 닫기
          document.querySelectorAll(".reply-form").forEach((form) => {
            if (form !== replyForm) {
              form.style.display = "none";
            }
          });

          // 현재 답글 폼 토글
          if (replyForm.style.display === "block") {
            replyForm.style.display = "none";
          } else {
            replyForm.style.display = "block";
          }
        });
      });

      // 댓글 작성 버튼 이벤트
      document
        .querySelector(".comment-form .btn-comment")
        .addEventListener("click", function () {
          const commentText = document
            .querySelector(".comment-form textarea")
            .value.trim();

          if (commentText) {
            // 현재 날짜 및 시간 가져오기
            const now = new Date();
            const dateString = `${now.getFullYear()}-${String(
              now.getMonth() + 1
            ).padStart(2, "0")}-${String(now.getDate()).padStart(
              2,
              "0"
            )} ${String(now.getHours()).padStart(2, "0")}:${String(
              now.getMinutes()
            ).padStart(2, "0")}`;

            // 새 댓글 요소 생성
            const newComment = document.createElement("div");
            newComment.className = "comment-item";
            newComment.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">사용자</span>
                        <span class="comment-date">${dateString}</span>
                    </div>
                    <div class="comment-text">
                        ${commentText}
                    </div>
                    <div class="comment-actions">
                        <button class="btn-reply" data-comment-id="new">
                            <i class="bi bi-reply"></i> 답글 달기
                        </button>
                    </div>
                    
                    <div class="reply-form" id="replyForm-new">
                        <textarea class="form-control comment-input" rows="2" placeholder="답글을 작성해주세요..."></textarea>
                        <button class="btn btn-comment btn-sm">답글 작성</button>
                        <div class="clearfix"></div>
                    </div>
                `;

            // 댓글 목록에 새 댓글 추가
            document.getElementById("commentsList").prepend(newComment);

            // 댓글 입력창 초기화
            document.querySelector(".comment-form textarea").value = "";

            // 댓글 수 업데이트
            updateCommentsCount();

            // 새로 추가된 답글 버튼에 이벤트 리스너 추가
            newComment
              .querySelector(".btn-reply")
              .addEventListener("click", function () {
                const replyForm = newComment.querySelector(".reply-form");

                // 다른 모든 답글 폼 닫기
                document.querySelectorAll(".reply-form").forEach((form) => {
                  if (form !== replyForm) {
                    form.style.display = "none";
                  }
                });

                // 현재 답글 폼 토글
                if (replyForm.style.display === "block") {
                  replyForm.style.display = "none";
                } else {
                  replyForm.style.display = "block";
                }
              });

            // 새로 추가된 답글 작성 버튼에 이벤트 리스너 추가
            newComment
              .querySelector(".reply-form .btn-comment")
              .addEventListener("click", function () {
                addReply(this);
              });
          }
        });

      // 답글 작성 버튼 이벤트
      document
        .querySelectorAll(".reply-form .btn-comment")
        .forEach((button) => {
          button.addEventListener("click", function () {
            addReply(this);
          });
        });

      // 답글 추가 함수
      function addReply(button) {
        const replyForm = button.closest(".reply-form");
        const commentItem = replyForm.closest(".comment-item");
        const replyText = replyForm.querySelector("textarea").value.trim();

        if (replyText) {
          // 현재 날짜 및 시간 가져오기
          const now = new Date();
          const dateString = `${now.getFullYear()}-${String(
            now.getMonth() + 1
          ).padStart(2, "0")}-${String(now.getDate()).padStart(
            2,
            "0"
          )} ${String(now.getHours()).padStart(2, "0")}:${String(
            now.getMinutes()
          ).padStart(2, "0")}`;

          // 새 답글 요소 생성
          const newReply = document.createElement("div");
          newReply.className = "reply-item";
          newReply.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">사용자</span>
                        <span class="comment-date">${dateString}</span>
                    </div>
                    <div class="comment-text">
                        ${replyText}
                    </div>
                `;

          // 답글 폼 뒤에 새 답글 추가
          replyForm.after(newReply);

          // 답글 입력창 초기화 및 폼 닫기
          replyForm.querySelector("textarea").value = "";
          replyForm.style.display = "none";
        }
      }

      // 댓글 수 업데이트 함수
      function updateCommentsCount() {
        const count = document.querySelectorAll(".comment-item").length;
        document.getElementById("commentsCount").textContent = count;
      }
    </script>
  </body>
</html>
