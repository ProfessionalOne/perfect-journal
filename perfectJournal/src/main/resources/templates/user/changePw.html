<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>감사일기 - 비밀번호 변경</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap");

      body {
        font-family: "Noto Sans KR", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        background-color: #f5f5f7;
        color: #1d1d1f;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .password-change-container {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.4) 0%,
          rgba(255, 255, 255, 0.2) 100%
        );
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        border-radius: 24px;
        padding: 2rem;
        width: 100%;
        max-width: 450px;
        margin: 2rem auto;
      }

      .bg-pattern {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.4;
        background-image: radial-gradient(
            circle at 25% 25%,
            rgba(0, 113, 227, 0.2) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 75% 75%,
            rgba(255, 149, 0, 0.2) 0%,
            transparent 50%
          );
      }

      .logo-icon {
        filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.1));
        width: 55px;
        margin-bottom: 1rem;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      .floating {
        animation: float 6s ease-in-out infinite;
      }

      .form-control {
        background-color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        padding: 0.75rem 1rem;
        border-radius: 12px;
      }

      .form-control:focus {
        background-color: rgba(255, 255, 255, 0.9);
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
      }

      .btn-primary {
        background-color: #0d6efd;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        background-color: #0b5ed7;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(13, 110, 253, 0.4);
      }

      .form-text {
        font-size: 0.75rem;
        margin-top: 0.25rem;
        margin-left: 0.5rem;
      }

      .progress {
        height: 4px;
        background-color: #e0e0e0;
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background-color: #0d6efd;
        border-radius: 2px;
        transition: width 0.3s ease;
      }

      .form-control.is-valid {
        border-color: #198754;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .form-control.is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .result-box {
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: none;
      }

      .result-box.show {
        display: block;
      }

      .result-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto 16px;
        background-color: #e3f2fd;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .result-icon svg {
        width: 32px;
        height: 32px;
        color: #3a5745;
      }

      .footer {
        position: absolute;
        bottom: 1rem;
        width: 100%;
        text-align: center;
        font-size: 0.75rem;
        color: #6c757d;
      }

      .logo {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <div class="bg-pattern"></div>

    <div class="container">
      <div class="password-change-container">
        <div class="text-center mb-4">
          <div class="d-inline-block">
            <img
              class="logo-icon floating"
              viewBox="0 0 24 24"
              fill="none"
              src="/images/logoIcon.png"
            />
          </div>
          <h2><img class="logo" src="/images/logo.png" /></h2>
          <p class="text-secondary mt-2">비밀번호 변경</p>
        </div>

        <form id="passwordChangeForm">
          <div class="mb-3">
            <label for="userid" class="form-label"
              >아이디 <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control"
              id="userid"
              placeholder="아이디를 입력하세요"
              required
            />
          </div>

          <div class="mb-3">
            <label for="new-password" class="form-label"
              >새 비밀번호 <span class="text-danger">*</span></label
            >
            <input
              type="password"
              class="form-control"
              id="new-password"
              placeholder="새 비밀번호를 입력하세요"
              required
            />
            <div class="progress mt-2">
              <div
                class="progress-bar"
                id="password-strength"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <div class="form-text" id="password-feedback">
              영문, 숫자, 특수문자 조합 8-20자
            </div>
          </div>

          <div class="mb-4">
            <label for="confirm-password" class="form-label"
              >비밀번호 확인 <span class="text-danger">*</span></label
            >
            <input
              type="password"
              class="form-control"
              id="confirm-password"
              placeholder="새 비밀번호를 다시 입력하세요"
              required
            />
            <div class="form-text" id="password-confirm-feedback"></div>
          </div>

          <div class="d-grid mb-4">
            <button
              type="button"
              id="change-password-btn"
              class="btn btn-primary"
            >
              비밀번호 변경
            </button>
          </div>

          <div class="text-center">
            <a href="#" class="text-decoration-none" th:href="@{/users/login}"
              >로그인 페이지로 돌아가기</a
            >
          </div>
        </form>

        <!-- 비밀번호 변경 결과 -->
        <div id="result-box" class="result-box">
          <div class="result-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h3 class="fs-5 fw-medium text-dark mb-2">비밀번호 변경 완료</h3>
          <p class="text-secondary mb-4">
            비밀번호가 성공적으로 변경되었습니다.
          </p>
          <div class="d-grid">
            <button
              type="button"
              class="btn btn-primary"
              th:href="@{/users/login}"
            >
              로그인 페이지로 이동
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">© 2023 감사일기. All rights reserved.</div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // 비밀번호 강도 표시 기능
      const passwordInput = document.getElementById("new-password");
      const passwordStrength = document.getElementById("password-strength");
      const passwordFeedback = document.getElementById("password-feedback");

      passwordInput.addEventListener("input", function () {
        const password = this.value;
        let strength = 0;

        // 길이 체크
        if (password.length >= 8) strength += 25;

        // 대문자 체크
        if (/[A-Z]/.test(password)) strength += 25;

        // 소문자 체크
        if (/[a-z]/.test(password)) strength += 25;

        // 숫자 체크
        if (/[0-9]/.test(password)) strength += 12.5;

        // 특수문자 체크
        if (/[^A-Za-z0-9]/.test(password)) strength += 12.5;

        passwordStrength.style.width = `${strength}%`;

        // 강도에 따른 색상 변경
        if (strength < 30) {
          passwordStrength.className = "progress-bar bg-danger";
          passwordFeedback.className = "form-text text-danger";
          passwordFeedback.textContent = "비밀번호가 너무 약합니다";
        } else if (strength < 60) {
          passwordStrength.className = "progress-bar bg-warning";
          passwordFeedback.className = "form-text text-warning";
          passwordFeedback.textContent = "비밀번호가 적당합니다";
        } else {
          passwordStrength.className = "progress-bar bg-success";
          passwordFeedback.className = "form-text text-success";
          passwordFeedback.textContent = "비밀번호가 안전합니다";
        }
      });

      // 비밀번호 확인 일치 체크
      const passwordConfirmInput = document.getElementById("confirm-password");
      const passwordConfirmFeedback = document.getElementById(
        "password-confirm-feedback"
      );

      passwordConfirmInput.addEventListener("input", function () {
        if (this.value === passwordInput.value) {
          this.classList.add("is-valid");
          this.classList.remove("is-invalid");
          passwordConfirmFeedback.className = "form-text text-success";
          passwordConfirmFeedback.textContent = "비밀번호가 일치합니다";
        } else {
          this.classList.add("is-invalid");
          this.classList.remove("is-valid");
          passwordConfirmFeedback.className = "form-text text-danger";
          passwordConfirmFeedback.textContent = "비밀번호가 일치하지 않습니다";
        }
      });

      document
        .getElementById("change-password-btn")
        .addEventListener("click", function () {
          const userid = document.getElementById("userid").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          if (!userid || !newPassword || !confirmPassword) {
            alert("모든 필드를 입력해주세요.");
            return;
          }

          if (newPassword !== confirmPassword) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
          }

          // 실제 서버로 요청 보내는 fetch 코드 추가
          fetch("/users/changePw", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              user: userid,
              password: newPassword,
            }),
          })
            .then((response) => {
              if (response.redirected) {
                window.location.href = response.url; // 리디렉션 시 이동
              } else if (response.ok) {
                // 변경 완료 UI 표시
                document.getElementById("passwordChangeForm").style.display =
                  "none";
                document.getElementById("result-box").classList.add("show");
              } else {
                alert("비밀번호 변경에 실패했습니다.");
              }
            })
            .catch((error) => {
              console.error("에러 발생:", error);
              alert("서버 요청 중 오류가 발생했습니다.");
            });
        });
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9474ab8e06f2305f',t:'MTc0ODUwNzg1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
